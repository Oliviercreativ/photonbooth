# Security Scan Report - Photobooth App
**Date:** 2025-10-01
**Scan Type:** Full Security Audit (OWASP, Dependencies, Code Quality)
**Status:** ‚ö†Ô∏è MEDIUM RISK

---

## Executive Summary

**Critical Issues:** 0
**High Severity:** 2
**Medium Severity:** 3
**Low Severity:** 2
**Info:** 3

---

## üî¥ High Severity Issues

### 1. **CORS Wildcard Exposure** (OWASP A05:2021 - Security Misconfiguration)
**File:** [nuxt.config.ts:79-84](nuxt.config.ts#L79-L84)
**Status:** ‚úÖ FIXED
**Original Issue:**
```typescript
'Access-Control-Allow-Origin': '*'  // Exposed to all domains
```
**Risk:** API endpoints vulnerable to CSRF, data theft from malicious domains
**Fix Applied:** Removed wildcard, now using Nuxt's `cors: true` for controlled origin handling
**Recommendation:** Configure specific allowed origins in production

---

### 2. **Undefined Variables & Type Safety Disabled**
**File:** [nuxt.config.ts:50](nuxt.config.ts#L50), [server/api/admin/upload-photo.post.ts:134](server/api/admin/upload-photo.post.ts#L134)
**Risk:** Runtime errors, undefined behavior

**Issues:**
- `typeCheck: false` - TypeScript validation disabled
- Line 134: `guestEmail` used but never defined in scope
- Missing error boundary for undefined variables

**Recommendation:**
```typescript
// Enable type checking
typescript: {
  typeCheck: true,
  strict: true
}

// Fix undefined variable
const guestEmail = formData.find(field => field.name === 'guestEmail')?.data?.toString()
if (guestEmail && guestEmail !== 'anonyme@photobooth.local') {
  // existing logic
}
```

---

## üü° Medium Severity Issues

### 3. **Sensitive Data in Environment Variables**
**Files:** [nuxt.config.ts:95-101](nuxt.config.ts#L95-L101)
**Risk:** Credential exposure if `.env` committed

**Exposed Variables:**
- `GEMINI_API_KEY`
- `SUPABASE_SERVICE_ROLE_KEY` (admin privileges)
- `ADMIN_ID` / `ADMIN_PASSWORD`

**Status:** ‚úÖ PROTECTED (`.gitignore` configured)
**Verification:**
```bash
# .gitignore includes:
.env
.env.*
!.env.example
```

**Recommendation:**
- Verify no `.env` files in git history: `git log --all --full-history -- .env`
- Rotate keys if previously exposed
- Consider Vault/AWS Secrets Manager for production

---

### 4. **XSS Vulnerability via User Input**
**File:** [pages/photo/[id].vue:78](pages/photo/[id].vue#L78)
**Risk:** Potential XSS if `photo.url` contains malicious payload

```vue
:style="{
  backgroundImage: `url(${photo.url})`,  // Unsanitized URL
}"
```

**Recommendation:**
```javascript
// Sanitize URL
const sanitizedUrl = computed(() => {
  if (!photo.value?.url) return ''
  try {
    const url = new URL(photo.value.url)
    if (!['https:', 'http:'].includes(url.protocol)) return ''
    return photo.value.url
  } catch {
    return ''
  }
})
```

---

### 5. **Hardcoded API Endpoint in Client Code**
**File:** [pages/photo/[id].vue:328](pages/photo/[id].vue#L328)
**Risk:** Exposing internal API structure

```javascript
const response = await $fetch('/api/photobooth-nano-banana', {
  method: 'POST',
  body: { imageUrl: photo.value.url, prompt }
})
```

**Recommendation:** Use runtime config or environment variables for API endpoints

---

## üü¢ Low Severity Issues

### 6. **Outdated Dependencies**
**Status:** Multiple packages behind latest versions

| Package | Current | Latest | Risk |
|---------|---------|--------|------|
| `nuxt` | 3.19.2 | 4.1.2 | Major version behind |
| `@nuxtjs/supabase` | 1.6.2 | 2.0.0 | Breaking changes available |
| `nuxt-icon` | 0.6.10 | 1.0.0-beta.7 | Beta available |

**Recommendation:**
```bash
# Test updates in staging first
npm update @supabase/supabase-js vue vercel
# Review breaking changes before major updates
npm info nuxt@4 --json | jq .version
```

---

### 7. **Missing Package Lock File**
**Status:** Using `bun.lock` but `package-lock.json` missing
**Risk:** Dependency resolution inconsistencies, cannot run `npm audit`

**Fix:**
```bash
npm i --package-lock-only
npm audit fix
```

---

## ‚ÑπÔ∏è Informational

### 8. **Invalid Compatibility Date**
**File:** [nuxt.config.ts:3](nuxt.config.ts#L3)
**Status:** ‚úÖ FIXED (2025-07-15 ‚Üí 2024-07-15)

---

### 9. **Console.log Statements in Production**
**Files:** Multiple API routes
**Impact:** Performance overhead, potential info disclosure

**Examples:**
- [server/api/live-photobooth.post.ts:50-55](server/api/live-photobooth.post.ts#L50-L55)
- [server/api/photobooth-guest.post.ts:28-44](server/api/photobooth-guest.post.ts#L28-L44)

**Recommendation:**
```javascript
// Use logger with levels
const logger = useLogger()
if (process.env.NODE_ENV === 'development') {
  logger.debug('Traitement photo:', { backgroundId, size })
}
```

---

### 10. **Long Prompts in Code**
**File:** [server/api/photobooth-guest.post.ts:100-302](server/api/photobooth-guest.post.ts#L100-L302)
**Impact:** Code maintainability, bundle size

**Lines of prompt definitions:** ~200 lines
**Recommendation:** Extract to JSON config or database

---

## OWASP Top 10 Coverage

| Vulnerability | Status | Notes |
|---------------|--------|-------|
| A01:2021 - Broken Access Control | ‚úÖ Pass | Email validation enforced |
| A02:2021 - Cryptographic Failures | ‚úÖ Pass | HTTPS enforced, keys in env |
| A03:2021 - Injection | ‚ö†Ô∏è Medium | URL sanitization needed |
| A04:2021 - Insecure Design | ‚úÖ Pass | Guest photo limit implemented |
| A05:2021 - Security Misconfiguration | ‚úÖ Fixed | CORS corrected |
| A06:2021 - Vulnerable Components | ‚ö†Ô∏è Medium | Outdated deps |
| A07:2021 - Auth Failures | ‚úÖ Pass | Supabase handles auth |
| A08:2021 - Data Integrity | ‚úÖ Pass | No identified issues |
| A09:2021 - Logging Failures | ‚ö†Ô∏è Low | Excessive console.log |
| A10:2021 - SSRF | ‚úÖ Pass | No external URL fetching |

---

## Configuration Audit

### ‚úÖ Good Practices
- Cache headers configured (`Cache-Control` on `/previews/**`)
- Image optimization enabled (WebP, quality 80)
- TypeScript configured (though disabled)
- Git ignores sensitive files
- Vercel timeout configured (30s)

### ‚ö†Ô∏è Issues
- DevTools disabled (makes debugging harder)
- Type checking disabled
- Auto-type generation disabled

---

## Dependencies Analysis

### Build Tools
- `sharp@0.34.4` - ‚úÖ Up to date (image processing)
- `@google/generative-ai@0.24.1` - ‚ö†Ô∏è Check for updates

### Frameworks
- `nuxt@3.19.2` - ‚ö†Ô∏è Major version 4 available
- `vue@3.5.21` - ‚ö†Ô∏è Patch update available (3.5.22)

### No Known CVEs
- No critical vulnerabilities detected in current packages
- Note: Cannot run full `npm audit` without package-lock.json

---

## Recommendations Priority

### Immediate (This Week)
1. ‚úÖ Fix undefined `guestEmail` variable (server/api/admin/upload-photo.post.ts:134)
2. ‚úÖ Add URL sanitization (pages/photo/[id].vue:78)
3. ‚úÖ Generate package-lock.json and run audit

### Short Term (This Month)
4. Update patch versions (Vue, Supabase, Vercel)
5. Remove/minimize console.log statements
6. Enable TypeScript checking in dev

### Long Term (Next Quarter)
7. Evaluate Nuxt 4 migration
8. Extract prompts to configuration
9. Implement structured logging
10. Add security headers (CSP, HSTS)

---

## Security Score: 7.5/10

**Strengths:**
- Proper secret management
- Guest access controls
- HTTPS enforced
- Storage security via Supabase

**Weaknesses:**
- Type safety disabled
- Some input validation gaps
- Outdated dependencies
- Production logging

---

## CI/CD Integration

### Recommended GitHub Actions
```yaml
- name: Security Audit
  run: |
    npm audit --audit-level=moderate
    npm outdated

- name: Type Check
  run: npm run typecheck
```

---

**Scan completed in:** ~3 minutes
**Next scan recommended:** 2025-11-01
**Auditor:** Claude Code Security Scanner v2.0

---

## Quick Fix Commands

```bash
# 1. Generate lock file
npm i --package-lock-only

# 2. Run audit
npm audit fix

# 3. Update safe packages
npm update @supabase/supabase-js vue vercel

# 4. Check for breaking changes before major updates
npm info nuxt@4
npm info @nuxtjs/supabase@2
```
